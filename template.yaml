AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Yellow Card Backend Test - Transaction Service (SAM + LocalStack)

Parameters:
  AwsEndpointUrl:
    Type: String
    Default: ""
    Description: Optional endpoint override (LocalStack). Leave empty for AWS.

Conditions:
  HasAwsEndpointUrl: !Not [!Equals [!Ref AwsEndpointUrl, ""]]

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 10
    MemorySize: 256
    Environment:
      Variables:
        TABLE_NAME: !Ref TransactionsTable
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
        AWS_ENDPOINT_URL: !If
          - HasAwsEndpointUrl
          - !Ref AwsEndpointUrl
          - !Ref "AWS::NoValue"
        IDEMPOTENCY_TTL_SECONDS: "86400"

Resources:
  Api:
    Type: AWS::Serverless::Api
    Properties:
      StageName: local
      EndpointConfiguration: REGIONAL
      Cors:
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type,Idempotency-Key,X-Idempotency-Key'"
        AllowOrigin: "'*'"

  TransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: transactions
      BillingMode: PAY_PER_REQUEST
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  TransactionDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: transaction-dlq

  TransactionQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: transaction-queue
      VisibilityTimeout: 30
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TransactionDLQ.Arn
        maxReceiveCount: 3


  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: es2022
        Sourcemap: true
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
        EntryPoints:
          - src/healthCheck.ts
    Properties:
      Handler: healthCheck.handler
      Events:
        Health:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /health
            Method: GET

  CreateTransactionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: es2022
        Sourcemap: true
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
        EntryPoints:
          - src/createTransaction.ts
    Properties:
      Handler: createTransaction.handler
      Environment:
        Variables:
          QUEUE_URL: !Ref TransactionQueue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TransactionsTable
        - SQSSendMessagePolicy:
            QueueName: transaction-queue
      Events:
        CreateTransaction:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /transactions
            Method: POST

  GetTransactionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: es2022
        Sourcemap: true
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
        EntryPoints:
          - src/getTransaction.ts
    Properties:
      Handler: getTransaction.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TransactionsTable
      Events:
        GetTransaction:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /transactions/{id}
            Method: GET

  ProcessTransactionFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: es2022
        Sourcemap: true
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
        EntryPoints:
          - src/processTransaction.ts
    Properties:
      Handler: processTransaction.handler
      Environment:
        Variables:
          PROCESSING_DELAY_MS: "500"
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TransactionsTable
      Events:
        TransactionQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt TransactionQueue.Arn
            BatchSize: 1


Outputs:
  ApiBaseUrl:
    Description: Base URL of the API Gateway endpoint
    Value: !Sub "http://localhost:4566/restapis/${Api}/local/_user_request_"
